#!/bin/bash

# use for SourceTree And Xcode
if test -d "/opt/homebrew/bin/"; then
  PATH="/opt/homebrew/bin/:${PATH}"
fi
export PATH

# æ£€æµ‹swiftLintå·¥å…·æ˜¯å¦å®‰è£…
if [ -z "$(which swiftlint)" ]
then
    cat <<\EOF
    è®¾å¤‡ä¸Šæ²¡æœ‰æ£€æµ‹åˆ°SwiftLintï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œä¸‹è½½å®‰è£…ï¼š
    brew install swiftLint
EOF
    exit 1
fi

# æ¥æ”¶lintç»“æœï¼Œå¹¶è¿›è¡Œæ ¼å¼åŒ–å¤„ç†
function dealLintResult() {
  while read -r line; do
    FILE_NAME=$(echo "$line" | cut -d : -f 1 | rev | cut -d / -f 1 | rev)
    LINE=$(echo "$line" | cut -d : -f 2)
    COLUMN=$(echo "$line" | cut -d : -f 3)
    VIOLATION_TYPE=$(echo "$line" | cut -d : -f 4 | cut -c 2-)
    VIOLATION=$(echo "$line" | cut -d : -f 5 | cut -c 2-)
    DESCRIPTION=$(echo "$line" | cut -d : -f 6 | cut -c 2-)

    if [ "$VIOLATION_TYPE" == "warning" ]; then
      echo -e "\nâš ï¸  $VIOLATION \n"
    else
      echo -e "\nâŒ $VIOLATION \n"
    fi
    echo -e "$FILE_NAME: ç¬¬${LINE}è¡Œ ç¬¬${COLUMN}åˆ—ã€‚- $DESCRIPTION \n"
    echo "---------------------------------------------------------------------"
  done <<<"$1"
  
  printf "\nğŸ™…ğŸ»â€â™€ï¸ğŸˆ²æäº¤è¢«é˜»æ­¢ï¼Œè¯·åœ¨æäº¤å‰ä¿®å¤å¥½ä»¥ä¸Šé—®é¢˜\n"
  cat <<\EOF
  æˆ–ä½¿ç”¨ç»ˆæå‘½ä»¤ git commit -m 'xxx' --no-verify ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼‰
EOF
}

EXIT_CODE=0

COMMIT_SWIFT_FILES=()
# æœé›†un-staged filesä¸­çš„swiftæ–‡ä»¶
CHANGED_FILES_UNSTAGED=$(git diff --diff-filter=d --name-only -- "*.swift")
if [ "$CHANGED_FILES_UNSTAGED" ]; then
  COMMIT_SWIFT_FILES+=("$CHANGED_FILES_UNSTAGED")
fi

# æœé›†staged filesä¸­çš„swiftæ–‡ä»¶
CHANGED_FILES_STAGED=$(git diff --cached --diff-filter=d --name-only -- "*.swift")
if [ "$CHANGED_FILES_STAGED" ]; then
  COMMIT_SWIFT_FILES+=("$CHANGED_FILES_STAGED")
fi

# éå†æ‰€æœ‰æ·»åŠ çš„swiftæ–‡ä»¶ï¼Œå¹¶å¯¹å…¶é€ä¸€è¿›è¡Œlint
while read -r swiftfile; do
  LINTRESULT=$($(which swiftlint) lint --quiet --path "$swiftfile" --config ".swiftlint.yml")
  if [ -n "$LINTRESULT" ]; then
    dealLintResult "$LINTRESULT"
    EXIT_CODE=1
  fi
done <<<"${COMMIT_SWIFT_FILES[@]}"

exit $EXIT_CODE

